#!/bin/bash

#
# Serve kickstart file
#
pgrep -f "python -m SimpleHTTPServer" | xargs --no-run-if-empty kill
cd /var/www/html && python -m SimpleHTTPServer &

#
# Run virt-install to build (or rebuild) <loc>-foreman-1
#
virsh destroy <%= @certname %>
virsh undefine <%= @certname %>
virsh vol-delete --pool diskpool <%= @certname %>.img
virsh pool-refresh diskpool
virt-install -v \
  -n <%= @certname %> \
  -r 4096 \
  --vcpus 2 \
  --autostart \
  --os-variant=rhel7 \
  --accelerate \
  -w network=direct-net \
  --disk pool=diskpool,size=10 --force \
  -l <%= @mirror %>/ \
  --graphics vnc,listen=<%= @ipaddress %> --noautoconsole \
  -x "ks=<%= @ks_url %> network ks.sendmac net.ifnames=0 \
<% if @install_ip %>
     ip=<%= @install_ip %> \
     netmask=<%= @install_netmask %> \
     gateway=<%= @install_gw %> \
     dns=8.8.8.8 \
<% end %>
     " &

